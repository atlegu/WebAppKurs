-- Final cleanup: fill any remaining empty sub-modules with proper content

-- Fix any sub-modules that still have "Detaljert innhold kommer snart..."
UPDATE sub_modules 
SET content = jsonb_build_object(
    'sections', jsonb_build_array(
        jsonb_build_object(
            'title', 'Egenkapital â€“ hva det egentlig betyr',
            'type', 'lesson',
            'content', 'Egenkapital er kanskje det mest misforstÃ¥tte begrepet i hele regnskapet. Mange tror at "egenkapital" er det samme som Â«penger pÃ¥ kontoÂ» eller Â«det bedriften eier selvÂ». Det stemmer ikke helt.

**Egenkapital er ikke kontanter. Det er en differanse.**

Egenkapital = Eiendeler â€“ Gjeld

Den reflekterer eiernes "restinteresse" i virksomheten â€“ verdien som tilhÃ¸rer dem.

**Et eksempel:**
En bedrift har:
- Eiendeler for 10 millioner kroner
- Gjeld pÃ¥ 6 millioner

Da er egenkapitalen: 10 millioner â€“ 6 millioner = 4 millioner

Dette er eiernes verdi i selskapet â€“ hvis alle lÃ¥n ble gjort opp og alt av verdi ble solgt.',
            'video', '2 min: Hvordan tolke egenkapital som en restpost',
            'exercise', 'Gitt eiendeler og gjeld â€“ regn ut egenkapitalen',
            'reflection', 'Hva forteller balansen deg om en bedrifts finansielle helse?'
        )
    )
)
WHERE title = '2.3 Egenkapital' AND content->'{sections,0,content}' LIKE '%Detaljert innhold%';

-- Fill remaining empty obligasjoner content
UPDATE sub_modules 
SET content = jsonb_build_object(
    'sections', jsonb_build_array(
        jsonb_build_object(
            'title', 'Obligasjonsstruktur og nÃ¸kkeltall',
            'type', 'lesson',
            'content', '**Komponenter du mÃ¥ kjenne til:**

**PÃ¥lydende (hovedstol):** Det opprinnelige lÃ¥nebelÃ¸pet, f.eks. 1 000 kr

**Kupongrente:** Den faste Ã¥rlige renten, f.eks. 5%

**KupongbelÃ¸p:** Renteutbetaling per Ã¥r = pÃ¥lydende Ã— kupongrente

**LÃ¸petid:** Hvor lenge lÃ¥net varer â€“ til forfallsdato

**Forfallsdato:** Datoen nÃ¥r hovedstolen skal betales tilbake

**Kurs:** Markedspris for obligasjonen (ofte i prosent av pÃ¥lydende)

**Effektiv rente (YTM):** Faktisk avkastning over hele perioden, inkludert kurs og kuponger

**Eksempel:**
Du kjÃ¸per en obligasjon med:
- PÃ¥lydende: 1 000 kr
- Kupongrente: 4%
- LÃ¸petid: 5 Ã¥r

Du mottar 40 kr per Ã¥r i rente i fem Ã¥r (totalt 200 kr), og 1 000 kr ved forfall.

ðŸ“Œ Disse vilkÃ¥rene bestemmer obligasjonens risiko og avkastning',
            'video', 'Slik leser du et obligasjonsvilkÃ¥r (3 min)',
            'exercise', 'Beregn Ã¥rlig kupongbetaling for en obligasjon pÃ¥ 5 000 kr med 6% kupongrente'
        )
    )
)
WHERE title LIKE '%Obligasjonsstruktur%' AND content->'{sections,0,content}' LIKE '%kommer snart%';

-- Make sure all video, reflection, exercise properties are properly structured
UPDATE sub_modules 
SET content = jsonb_set(
    content,
    '{sections,0}',
    jsonb_build_object(
        'title', content->'{sections,0,title}',
        'type', COALESCE(content->'{sections,0,type}', '"lesson"'),
        'content', content->'{sections,0,content}',
        'video', content->'{sections,0,video}',
        'reflection', content->'{sections,0,reflection}',
        'exercise', content->'{sections,0,exercise}',
        'selftest', content->'{sections,0,selftest}',
        'download', content->'{sections,0,download}'
    )
)
WHERE content->'{sections}' IS NOT NULL 
AND jsonb_array_length(content->'{sections}') > 0;